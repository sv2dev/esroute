(()=>{var x=Object.defineProperty,O=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var d=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var R=(o,e,t)=>e in o?x(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,u=(o,e)=>{for(var t in e||(e={}))P.call(e,t)&&R(o,t,e[t]);if(d)for(var t of d(e))L.call(e,t)&&R(o,t,e[t]);return o},g=(o,e)=>O(o,N(e));var a=class{constructor(e,{replace:t,search:r,state:n}={}){this.params=[];if(typeof e=="string"){e.startsWith("/")||(e=`/${e}`),r||(this._href=e);let[s,i]=e.split("?");this._pathString=s,r!=null||(r=i)}else this._path=e;typeof r=="string"?this._searchString=r.replace(/^\?/,""):this._search=r!=null?r:{},n!==void 0&&(this.state=n),t!==void 0&&(this.replace=t)}get path(){var e;return(e=this._path)!=null?e:this._path=this.pathString.split("/").filter(Boolean)}get pathString(){var e;return(e=this._pathString)!=null?e:this._pathString=`/${this._path.join("/")}`}get search(){if(this._search)return this._search;this._search={};for(let e of this._searchString.split("&"))if(e){let[t,r]=e.split("=");this._search[t]=r?decodeURIComponent(r):""}return this._search}get searchString(){return this._searchString?this._searchString:this._searchString=Object.keys(this._search).map(e=>{let t=this._search[e];return`${e}${t?`=${encodeURIComponent(t)}`:""}`}).join("&")}get href(){var e;return(e=this._href)!=null?e:this._href=`${this.pathString}${this.searchString?`?${this.searchString}`:""}`}get go(){return(e,t={})=>{var r;return new a(e,{search:t.search,state:t.state,replace:(r=t.replace)!=null?r:this.replace})}}equals(e){return this.href===e.href&&this.replace===e.replace&&this.state===e.state&&this.params.every((t,r)=>t===e.params[r])}toString(){return this.href}};var m=(o=10)=>async(e,t,r)=>{let n=t,s=new Array;for(;n instanceof a&&s.length<=o;){t=n;let i=s.find(w=>w.equals(t));if(i)throw new Error(`Detected redirect loop: ${[...s,i].join(" -> ")}`);s.push(t);let h=await $(e,t);n=await(h!=null?h:r)(t)}if(s.length>o)throw new Error(`Exceeded max redirects: ${s.join(" -> ")}`);return{value:n,opts:t}},$=async(o,e)=>{var r;let t=await b(o,e);return t&&(typeof t=="function"?t:(r=t["/"])!=null?r:null)},b=async(o,e)=>{var r;let t=o;for(let n of e.path){if(t===null||typeof t=="function")return null;let s=k(t,e,n),i=await((r=t["?"])==null?void 0:r.call(t,e));if(i instanceof a)return()=>i;t=s}return t},k=(o,e,t)=>t in o?o[t]:"*"in o?(e.params.push(t),o["*"]):null;var T=()=>o=>o,p=o=>{if(typeof o!="object")return o;let e=[];for(let t in o)t.length===1||!t.includes("/")?p(o[t]):e.push(t);for(let t of e){let r=t.split("/"),n;for(;!(n=r.pop()););let s=o;for(let i of r)if(i)i in s&&typeof s[i]!="object"?s=s[i]={"/":s[i]}:i in s?s=s[i]:s=s[i]={};else continue;if(n in s)if(typeof s[n]=="object"&&!("/"in s[n]))s[n]=g(u({},s[n]),{"/":o[t]});else throw new Error(`Route conflict. Cannot add: ${t} to ${o}.`);else s[n]=o[t];p(s[n]),delete o[t]}return o},f=(o,e=[])=>{if(o==null||typeof o!="object"&&typeof o!="function")throw new Error(`Found invalid route definition '/${e.join("/")}': ${o}`);if(typeof o=="object")for(let t in o){if(t.length>1&&t.includes("/"))throw new Error(`Route '${t}', found in /${e.join("/")} is invalid.`);f(o[t])}return o};var v=class{constructor(e={},{notFound:t=({go:s})=>s([]),noClick:r=!1,resolver:n}){this.routes=e;this._listeners=new Set;this._linkClickListener=e=>{var r;let t=y(e.target)?e.target:(r=e.composedPath)==null?void 0:r.call(e).find(y);t&&t.origin===location.origin&&(this.go(t.pathname,{replace:"replace"in t.dataset}),e.preventDefault())};this._popStateListener=async({state:e})=>{let{pathname:t,search:r}=window.location,n=new a(`${t}${r}`,{state:e}),{opts:s}=await this._applyResolution(this._resolve(n));s!==n&&this._updateState(new a(s.path,{replace:!0,search:s.search,state:s.state}))};this._resolver=n,this._notFound=t,this._initListeners(r)}async go(e,t){await this.resolution;let r=e instanceof a?e:new a(e,t),n=await this._applyResolution(this._resolve(r));this._updateState(n.opts)}onResolve(e){return this._listeners.add(e),this._resolved&&e(this._resolved),()=>this._listeners.delete(e)}dispose(){window.removeEventListener("popstate",this._popStateListener),document.removeEventListener("click",this._linkClickListener)}_initListeners(e){window.addEventListener("popstate",this._popStateListener),e||document.addEventListener("click",this._linkClickListener),this._popStateListener({state:history.state})}async _applyResolution(e){return this.resolution=e,this._resolved=await e,this._listeners.forEach(t=>t(this._resolved)),e}_updateState({state:e,replace:t,href:r}){let n=window.history;n[t?"replaceState":"pushState"].call(n,e,"",r)}async _resolve(e){return this._resolver(this.routes,e,this._notFound)}},y=o=>o instanceof HTMLAnchorElement,_=(o,e={})=>new v(f(p(o)),u({resolver:m()},e));var c=T(),l=o=>fetch(o).then(e=>e.text());var S=c({"/":()=>l("routes/foo.html")});var E=c({"/":o=>(console.log(o),l("routes/root.html")),foo:()=>l("routes/foo.html"),bar:()=>l("routes/bar.html"),x:{"/":()=>"abc","*":({params:[o]})=>(console.log(o),l("routes/foo.html"))},"/x/y/*/*":({params:[o,e]})=>(console.log({param1:o,param2:e}),l("routes/foo.html")),a:S}),j=_(E,{notFound:({href:o,go:e})=>(console.warn("Route not found",o),e([]))});j.onResolve(({value:o})=>X(o));var X=o=>document.body.innerHTML=o;})();
//# sourceMappingURL=demo.js.map
